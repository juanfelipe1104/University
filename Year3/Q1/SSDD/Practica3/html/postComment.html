<!DOCTYPE html>
<html>

<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script>

    function requireLogin() {
      const u = localStorage.getItem("loggedUser");
      if (!u) {
        window.location.href = "login.html";
        return;
      }
      const userInput = document.getElementById("username");
      if (userInput) {
        userInput.value = u;
        userInput.readOnly = true;
      }
    }

    function logout() {
      localStorage.removeItem("loggedUser");
      window.location.href = "login.html";
    }

    const syncWait = ms => {
      const end = Date.now() + ms
      while (Date.now() < end) continue
    }

    function getAWSKeys() {
      var asd = $.get(
        "https://omqvgznq2oopnuzmvzceg42ghy0bqrbb.lambda-url.us-east-1.on.aws/",
        {},
        function (data) {

          var json = data;
          //        json=JSON.parse(json);
          document.getElementById("Policy").value = json.stringToSign;
          document.getElementById("X-Amz-Credential").value = json.xAmzCredential;
          document.getElementById("X-Amz-Date").value = json.amzDate;
          document.getElementById("X-Amz-Signature").value = json.stringSigned;
          document.getElementById("X-Amz-Security-Token").value = json.securityToken;

        }
      )

    }

    function setKeyFilename() {
      alert("Enviando!");

      document.getElementById("key").value = document.getElementById("file").value.substring(document.getElementById("file").value.lastIndexOf('\\') + 1);

      var post = document.getElementById("post").value;
      var file = document.getElementById("key").value;
      var user = document.getElementById("username").value;

      var sendPost = $.get(
        "https://qicalywih7x2xd7amoxc6gitde0xwrqf.lambda-url.us-east-1.on.aws/",

        { user: user, comment: post, attachment: file },
        function (data) {

          function jsonEscape(str) {
            return str.replace(/\n/g, "\\\\n").replace(/\r/g, "\\\\r").replace(/\t/g, "\\\\t").replace(/\\/g, "");
          }

          var json = data;
          alert('resultado ' + JSON.stringify(json));

        }
      )
      /*      .done(function() {
              alert( "second success" );
            })
            .fail(function(xhr, status, error) {
              alert( error );
            })
            
          sendPost.always(function() {
          alert( "second finished" );
          });
      */
      syncWait(3000);

    }


  </script>



</head>

<body onload="getAWSKeys();">

  <label for="username">Nombre de usuario:</label>
  <input type="text" id="username" name="username" value="userPrueba" /><br><br>
  <label for="post">Escribe un mensaje:</label>
  <textarea id="post" name="post" rows="5" cols="33">
</textarea>



  <form action="https://juanfelipe1104-twitter-bucket.s3.us-east-1.amazonaws.com" onsubmit="setKeyFilename()"
    method="post" enctype="multipart/form-data">
    <input type="hidden" id="X-Amz-Credential" name="X-Amz-Credential" value="" />
    <input type="hidden" id="X-Amz-Date" name="X-Amz-Date" value="" />
    <input type="hidden" id="Policy" name="Policy" value="" />
    <input type="hidden" id="X-Amz-Signature" name="X-Amz-Signature" value="" />
    <input type="hidden" id="key" name="key" value="fichero.sln" /><br />
    <input type="hidden" name="acl" value="public-read" />
    <input type="hidden" name="success_action_redirect"
      value="https://juanfelipe1104-twitter-bucket.s3.us-east-1.amazonaws.com/success.html" />
    <input type="hidden" name="X-Amz-Algorithm" value="AWS4-HMAC-SHA256" />
    <input type="hidden" id="X-Amz-Security-Token" name="X-Amz-Security-Token" value="" />

    <label for="file">Adjuntar un fichero:</label>
    <input type="file" name="file" id="file" accept="video/mp4,image/png"><br><br>
    <input type="submit" value="Subir fichero" name="submit">
  </form>

</body>

</html>